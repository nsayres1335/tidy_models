---
title: "14. Iterative Search"
format: html
date: last-modified
execute:
    cache: true
code-fold: true
toc: true
---

```{r}
#| label: code

library(tidymodels)

data(cells)
cells <- cells %>% select(-case)

set.seed(1304)
cell_folds <- vfold_cv(cells)

roc_res <- metric_set(roc_auc)
```

## 14.1 A Support Vector Machine Model

SVMs can provide a nice 2d viz of search process. Here we set up a SVM model with two hyperparameters to tune: `cost` and `rbf_sigma`. 

```{r}
library(tidymodels)
tidymodels_prefer()

svm_rec <-
  recipe(class ~ ., data = cells) %>%
  step_YeoJohnson(all_numeric_predictors()) %>%
  step_normalize(all_numeric_predictors())

svm_spec <-
  svm_rbf(cost = tune(), rbf_sigma = tune()) %>%
  set_engine("kernlab") %>%
  set_mode("classification")

svm_wflow <-
  workflow() %>%
  add_model(svm_spec) %>%
  add_recipe(svm_rec)
```

Checking defaults on tuning params. 

```{r}
#| label: tuning-params-defaults

cost()

rbf_sigma()
```

Updating kernel to improve viz of search space.

```{r}
#| label: updating-kernel

svm_param <-
  svm_wflow %>%
  extract_parameter_set_dials() %>%
  update(rbf_sigma = rbf_sigma(c(-7, -1)))
```

Need to setup a grid for initial results.

```{r}
#| label: initial-grid

set.seed(1401)
start_grid <-
  svm_param %>%
  update(
    cost = cost(c(-6, 1)),
    rbf_sigma = rbf_sigma(c(-6, -4))
  ) %>%
  grid_regular(levels = 2)

set.seed(1402)
svm_initial <-
  svm_wflow %>%
  tune_grid(resamples = cell_folds, grid = start_grid, metrics = roc_res)

collect_metrics(svm_initial)
```

## 14.2. Bayesian Optimization

Want to use the 1st SVM results as initial substrate in Gaussian process (GP) model. We want to maximize ROC AUC.

```{r}
#| label: bayes-opt-setup

ctrl <- control_bayes(verbose = TRUE)

set.seed(1403)
svm_bo <-
  svm_wflow %>%
  tune_bayes(
    resamples = cell_folds,
    metrics = roc_res,
    initial = svm_initial,
    param_info = svm_param,
    iter = 25,
    control = ctrl
  )
```

```{r}
#| label: bayes-opt-results

show_best(svm_bo)

autoplot(svm_bo, type = "performance")
```

## 14.3. Simulated Annealing

Global search that does a random walk through the parameter space, accepting some worse solutions to escape local optima.

```{r}
#| label: sim-anneal-setup

library(finetune)

ctrl_sa <- control_sim_anneal(verbose = TRUE, no_improve = 10L)

set.seed(1404)
svm_sa <-
  svm_wflow %>%
  tune_sim_anneal(
    resamples = cell_folds,
    metrics = roc_res,
    initial = svm_initial,
    param_info = svm_param,
    iter = 50,
    control = ctrl_sa
  )
```


```{r}
#| label: sim-anneal-results

show_best(svm_sa)

autoplot(svm_sa, type = "performance")
autoplot(svm_sa, type = "parameters")
```